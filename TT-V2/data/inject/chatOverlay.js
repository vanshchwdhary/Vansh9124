let offsetX,offsetY,resizeStartX,resizeStartY,resizeStartWidth,resizeStartHeight,chatVisible=!1,chatHistory=[],isDraggingOverlay=!1,isDraggingButton=!1,isResizing=!1;function createChatOverlay(){const e=document.createElement("div");e.id="chat-overlay",e.style.cssText=`\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    width: 350px;\n    height: 500px;\n    background-color: #fff;\n    border: 1px solid #ddd;\n    border-radius: 12px;\n    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);\n    z-index: 9999;\n    display: ${chatVisible?"flex":"none"};\n    flex-direction: column;\n    font-family: 'Arial', sans-serif;\n  `;const t=document.createElement("div");t.style.cssText="\n    padding: 15px;\n    border-bottom: 1px solid #ddd;\n    font-weight: bold;\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    background-color: #f8f8f8;\n    color: #333;\n    cursor: move;\n  ",t.innerHTML='\n    <span>Chat</span>\n    <span id="clear-chat" style="cursor: pointer; color: #f00;">Clear</span>\n    <span id="close-chat" style="cursor: pointer; margin-left: 10px;">Ã—</span>\n  ';const n=document.createElement("div");n.id="chat-messages",n.style.cssText="\n    padding: 15px;\n    flex: 1;\n    overflow-y: auto;\n    background-color: #fafafa;\n    color: #333;\n  ";const o=document.createElement("div");o.style.cssText="\n    padding: 15px;\n    border-top: 1px solid #ddd;\n    background-color: #fff;\n    display: flex;\n    align-items: center;\n  ";const r=document.createElement("div");r.contentEditable=!0,r.placeholder="Type a message...",r.style.cssText="\n    width: calc(100% - 40px);\n    padding: 10px;\n    border: 1px solid #ddd;\n    border-radius: 8px;\n    outline: none;\n    background-color: #fff;\n    color: #333;\n    min-height: 40px;\n    max-height: 100px;\n    font-family: 'Arial', sans-serif;\n    font-size: 14px;\n    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);\n    overflow-y: auto;\n  ";const i=document.createElement("button");i.innerHTML="â†©",i.style.cssText="\n    margin-left: 10px;\n    padding: 10px;\n    background-color: #007bff;\n    color: #fff;\n    border: none;\n    border-radius: 8px;\n    cursor: pointer;\n    font-size: 14px;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n  ";const a=document.createElement("div");a.style.cssText="\n    position: absolute;\n    bottom: 0;\n    right: 0;\n    width: 10px;\n    height: 10px;\n    background-color: #007bff;\n    cursor: se-resize;\n  ",o.appendChild(r),o.appendChild(i),e.appendChild(t),e.appendChild(n),e.appendChild(o),e.appendChild(a),document.body.appendChild(e);const s=document.createElement("style");s.innerHTML="\n    #chat-overlay ::-webkit-scrollbar {\n        width: 10px;\n        height: 10px;\n        transition: 1.0s;\n    }\n\n    #chat-overlay ::-webkit-scrollbar-thumb {\n        background-color: rgba(127, 127, 127, 0.6);\n        background-clip: padding-box;\n        border: 2px solid transparent;\n        border-radius: 5px;\n        transition: 1.0s;\n    }\n\n    #chat-overlay ::-webkit-scrollbar-thumb:vertical:hover,\n    #chat-overlay ::-webkit-scrollbar-thumb:horizontal:hover {\n        background-color: rgb(110, 110, 110);\n        transition: 0.3s;\n    }\n\n    #chat-overlay ::-webkit-scrollbar-track {\n        background-color: transparent;\n    }\n\n    #chat-overlay ::-webkit-scrollbar-thumb:vertical:active,\n    #chat-overlay ::-webkit-scrollbar-thumb:horizontal:active {\n        background: rgba(95, 91, 91, 1);\n    }\n\n    #chat-overlay ::-webkit-scrollbar-corner {\n        background: none;\n    }\n  ",document.head.appendChild(s),t.addEventListener("mousedown",(t=>{isDraggingOverlay=!0,offsetX=t.clientX-e.getBoundingClientRect().left,offsetY=t.clientY-e.getBoundingClientRect().top})),a.addEventListener("mousedown",(t=>{isResizing=!0,resizeStartX=t.clientX,resizeStartY=t.clientY,resizeStartWidth=e.offsetWidth,resizeStartHeight=e.offsetHeight})),document.addEventListener("mousemove",(t=>{if(isDraggingOverlay&&(e.style.left=t.clientX-offsetX+"px",e.style.top=t.clientY-offsetY+"px",e.style.bottom="auto",e.style.right="auto"),isResizing){const n=resizeStartWidth+(t.clientX-resizeStartX),o=resizeStartHeight+(t.clientY-resizeStartY);e.style.width=`${n}px`,e.style.height=`${o}px`}})),document.addEventListener("mouseup",(()=>{isDraggingOverlay=!1,isResizing=!1})),document.getElementById("close-chat").addEventListener("click",(()=>{chatVisible=!1,e.style.display="none"})),document.getElementById("clear-chat").addEventListener("click",(()=>{chatHistory=[],n.innerHTML="",chrome.runtime.sendMessage({action:"resetContext"})})),i.addEventListener("click",(()=>{const e=r.innerText.trim();e&&(chatHistory.push({role:"user",content:e}),addMessageToChat(e,"user"),r.innerText="",n.scrollTop=n.scrollHeight,chrome.runtime.sendMessage({action:"processChatMessage",message:e,context:chatHistory}))})),r.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),i.click())})),document.addEventListener("keydown",(t=>{if(t.altKey&&"t"===t.key){chatVisible=!chatVisible;const e=document.getElementById("chat-overlay");e?e.style.display=chatVisible?"flex":"none":createChatOverlay()}"Escape"===t.key?(chatVisible=!1,e.style.display="none"):t.altKey&&"b"===t.key&&navigator.clipboard.readText().then((e=>{const t=document.activeElement;if(t&&(t.isContentEditable||"INPUT"===t.tagName||"TEXTAREA"===t.tagName)){t.isContentEditable?t.innerText+=e:t.value+=e;const n=new Event("input",{bubbles:!0});t.dispatchEvent(n)}else t.innerText+=e,t.value+=e})).catch((e=>{console.error("Failed to paste: ",e)}))}))}function createChatButton(){const e=document.createElement("button");e.id="chat-button",e.style.cssText="\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    width: 50px;\n    height: 50px;\n    background-color: #007bff;\n    border: none;\n    border-radius: 50%;\n    color: #fff;\n    font-size: 24px;\n    cursor: pointer;\n    z-index: 9999;\n    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);\n  ",e.innerHTML="ðŸ’¬",document.body.appendChild(e),e.addEventListener("dblclick",(()=>{chatVisible=!chatVisible;const e=document.getElementById("chat-overlay");e?e.style.display=chatVisible?"flex":"none":createChatOverlay()})),e.addEventListener("mousedown",(t=>{isDraggingButton=!0,offsetX=t.clientX-e.getBoundingClientRect().left,offsetY=t.clientY-e.getBoundingClientRect().top})),document.addEventListener("mousemove",(t=>{isDraggingButton&&(e.style.left=t.clientX-offsetX+"px",e.style.top=t.clientY-offsetY+"px",e.style.bottom="auto",e.style.right="auto")})),document.addEventListener("mouseup",(()=>{isDraggingButton=!1}))}function addMessageToChat(e,t){const n=document.getElementById("chat-messages"),o=document.createElement("div");o.style.cssText="\n    margin-bottom: 10px;\n    padding: 10px;\n    border-radius: 8px;\n    max-width: 90%;\n    word-wrap: break-word;\n  ","user"===t?(o.style.backgroundColor="#dcf8c6",o.style.alignSelf="flex-end",o.style.paddingLeft="10px"):(o.style.backgroundColor="#f1f1f1",o.style.alignSelf="flex-start",o.style.border="1px solid #ddd",o.style.paddingLeft="10px");const r=(new showdown.Converter).makeHtml(e),i=document.createElement("div");i.innerHTML=r,i.querySelectorAll("pre code").forEach((e=>{e.style.border="1px solid #ddd",e.style.borderRadius="4px",e.style.padding="12px",e.style.display="block",e.style.margin="15px 0",e.style.overflowX="auto",e.style.whiteSpace="pre";const t=document.createElement("button");t.innerText="Copy",t.style.cssText="\n      position: absolute;\n      right: 10px;\n      top: 10px;\n      background-color: #007bff;\n      color: #fff;\n      border: none;\n      border-radius: 4px;\n      cursor: pointer;\n      padding: 5px 10px;\n    ",t.addEventListener("click",(()=>{navigator.clipboard.writeText(e.innerText).then((()=>{t.innerText="Copied",setTimeout((()=>{t.innerText="Copy"}),5e3)})).catch((e=>{console.error("Failed to copy: ",e)}))})),e.parentNode.style.position="relative",e.parentNode.appendChild(t)})),o.appendChild(i),n.appendChild(o),n.scrollTop=n.scrollHeight}createChatButton(),chrome.runtime.onMessage.addListener(((e,t,n)=>{if("updateChatHistory"===e.action){const{role:t,content:n}=e;chatHistory.push({role:t,content:n}),addMessageToChat(n,t)}}));